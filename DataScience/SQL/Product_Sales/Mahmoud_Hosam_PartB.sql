use HSD_DW;

----- SNOWFLAKE Dimintions -----
/*CREATE TABLE Date_Dim(
Date_key Int Not Null
,Date Date Not NULL 
,Month int NOT NULL
,Month_text Char(50) not NULL 
,Quarter int not null
,Quarter_text char(50) not null 
,year int not null
,CONSTRAINT Date_key_PK PRIMARY KEY (Date_key)
);

CREATE TABLE TIMELINE(
TimeID Int NOT NULL
,Date_key Int Not Null
,CONSTRAINT TimeID_PK PRIMARY KEY (TimeID)
,CONSTRAINT Date_key_fk FOREIGN KEY(Date_key) REFERENCES Date_Dim(Date_key)
);*/

CREATE TABLE TIMELINE(
TimeID Int NOT NULL 
,Date Date Not NULL 
,Month int NOT NULL
,Month_text Char(50) not NULL 
,Quarter int not null
,Quarter_text char(50) not null 
,year int not null
,CONSTRAINT TimeID_PK PRIMARY KEY (TimeID)
);

INSERT INTO TIMELINE VALUES (43023, '15-OCT-2017', 10, 'October', 3, 'Qtr3', 2017);
INSERT INTO TIMELINE VALUES (43033, '25-OCT-2017', 10, 'October', 3, 'Qtr3', 2017);
INSERT INTO TIMELINE VALUES (43089, '20-DEC-2017', 12, 'December', 3, 'Qtr3', 2017);
INSERT INTO TIMELINE VALUES (43184, '25-MAR-2018', 3, 'March', 1, 'Qtr1', 2018);
INSERT INTO TIMELINE VALUES (43186, '27-MAR-2018', 3, 'March', 1, 'Qtr1', 2018);
INSERT INTO TIMELINE VALUES (43190, '31-MAR-2018', 3, 'March', 1, 'Qtr1', 2018);
INSERT INTO TIMELINE VALUES (43193, '03-APR-2018', 4, 'April', 2, 'Qtr2', 2018);
INSERT INTO TIMELINE VALUES (43198, '08-APR-2018', 4, 'April', 2, 'Qtr2', 2018);
INSERT INTO TIMELINE VALUES (43213, '23-APR-2018', 4, 'April', 2, 'Qtr2', 2018);
INSERT INTO TIMELINE VALUES (43227, '07-MAY-2018', 5, 'May', 2, 'Qtr2', 2018);
INSERT INTO TIMELINE VALUES (43241, '21-MAY-2018', 5, 'May', 2, 'Qtr2', 2018);
INSERT INTO TIMELINE VALUES (43256, '05-JUN-2018', 6, 'June', 2, 'Qtr2', 2018);

----- SNOWFLAKE Dimintions -----
/*CREATE TABLE CITY(
City_key int NOT NULL
,City VarChar(255) NOT NULL
,State Char(50) NOT NULL
,ZIP int NOT NULL
CONSTRAINT City_key_PK PRIMARY KEY(City_key)
);

CREATE TABLE CUSTOMER(
CustomerID Int NOT NULL 
,CustomerName VarChar(255) NOT NULL 
,Email VarChar(255) NOT NULL
,PhoneAreaCode int NOT NULL
,City_key int NOT NULL
,CONSTRAINT CustomerID_PK PRIMARY KEY(CustomerID)
,CONSTRAINT City_key_FK FOREIGN KEY(City_key) REFERENCES CITY(City_key)
);*/

CREATE TABLE CUSTOMER(
CustomerID Int NOT NULL 
,CustomerName VarChar(255) NOT NULL 
,Email VarChar(255) NOT NULL
,PhoneAreaCode int NOT NULL
,City VarChar(255) NOT NULL
,State Char(50) NOT NULL
,ZIP int NOT NULL
CONSTRAINT CustomerID_PK PRIMARY KEY(CustomerID)
);

INSERT INTO CUSTOMER VALUES (1, 'Jacobs, Nancy', 'somewhere.com', '817', 'Fort Worth', 'TX', '76110');
INSERT INTO CUSTOMER VALUES (2, 'Jacobs, Chantel', 'somewhere.com', '817', 'Fort Worth', 'TX', '76112');
INSERT INTO CUSTOMER VALUES (3, 'Able, Ralph', 'somewhere.com', '210', 'San Antonio', 'TX', '78214');
INSERT INTO CUSTOMER VALUES (4, 'Baker, Susan', 'elsewhere.com', '210', 'San Antonio', 'TX', '78216');
INSERT INTO CUSTOMER VALUES (5, 'Eagleton, Sam', 'elsewhere.com', '210', 'San Antonio', 'TX', '78218');
INSERT INTO CUSTOMER VALUES (6, 'Foxtrot, Kathy', 'somewhere.com', '972', 'Dallas', 'TX', '75220');
INSERT INTO CUSTOMER VALUES (7, 'George, Sally', 'somewhere.com', '972', 'Dallas', 'TX', '75223');
INSERT INTO CUSTOMER VALUES (8, 'Hullett, Shawn', 'elsewhere.com', '972', 'Dallas', 'TX', '75224');
INSERT INTO CUSTOMER VALUES (9, 'Pearson, Bobbi', 'elsewhere.com', '512', 'Austin', 'TX', '78710');
INSERT INTO CUSTOMER VALUES (10, 'Ranger, Terry', 'somewhere.com', '512', 'Austin', 'TX', '78712');
INSERT INTO CUSTOMER VALUES (11, 'Tyler, Jenny', 'somewhere.com', '972', 'Dallas', 'TX', '75225');
INSERT INTO CUSTOMER VALUES (12, 'Wayne, Joan', 'elsewhere.com', '817', 'Fort Worth', 'TX', '76115');

CREATE TABLE PRODUCT(
ProductNumber Char(50) NOT NULL
,ProductType Char(50) NOT NULL
,ProductName VarChar(255) NOT NULL
,CONSTRAINT ProductNumber_PK PRIMARY KEY(ProductNumber)
);

INSERT INTO PRODUCT VALUES ('BK001', 'Book', 'Kitchen Remodeling Basics For Everyone');
INSERT INTO PRODUCT VALUES ('BK002', 'Book', 'Advanced Kitchen Remodeling For Everyone');
INSERT INTO PRODUCT VALUES ('BK003', 'Book', 'Kitchen Remodeling Dallas Style For Everyone');
INSERT INTO PRODUCT VALUES ('VB001', 'Video Companion', 'Kitchen Remodeling Basics');
INSERT INTO PRODUCT VALUES ('VB002', 'Video Companion', 'Advanced Kitchen Remodeling I');
INSERT INTO PRODUCT VALUES ('VB003', 'Video Companion', 'Kitchen Remodeling Dallas Style');
INSERT INTO PRODUCT VALUES ('VK001', 'Video', 'Kitchen Remodeling Basics');
INSERT INTO PRODUCT VALUES ('VK002', 'Video', 'Advanced Kitchen Remodeling');
INSERT INTO PRODUCT VALUES ('VK003', 'Video', 'Kitchen Remodeling Dallas Style');
INSERT INTO PRODUCT VALUES ('VK004', 'Video', 'Heather Sweeney Seminar Live in Dallas on 25-OCT-16');

CREATE TABLE PRODUCT_SALES(
TimeID Int NOT NULL
,CustomerID Int NOT Null
,ProductNumber CHAR(50) NOT NULL
,Quantity Int NOT NULL
,UnitPrice FLOAT NOT NULL
,Total FLOAT NOT NULL

,CONSTRAINT PK PRIMARY KEY (TimeID, CustomerID, ProductNumber)
,CONSTRAINT TimeID_FK FOREIGN KEY(TimeID) REFERENCES TIMELINE(TimeID)
,CONSTRAINT CustomerID_FK FOREIGN KEY(CustomerID) REFERENCES CUSTOMER(CustomerID)
,CONSTRAINT ProductNumber_FK FOREIGN KEY(ProductNumber) REFERENCES PRODUCT(ProductNumber)
);

INSERT INTO PRODUCT_SALES VALUES (43023, 3, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43023, 3, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43033, 4, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43033, 4, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43033, 4, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43089, 7, 'VK004', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43184, 4, 'BK002', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43184, 4, 'VK002', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43184, 4, 'VK004', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 6, 'BK002', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 6, 'VB003', 1, 9.99, 9.99);
INSERT INTO PRODUCT_SALES VALUES (43186, 6, 'VK002', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 6, 'VK003', 1, 19.95, 19.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 6, 'VK004', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 7, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 7, 'BK002', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 7, 'VK003', 1, 19.95, 19.95);
INSERT INTO PRODUCT_SALES VALUES (43186, 7, 'VK004', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43190, 9, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43190, 9, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43190, 9, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43193, 11, 'VB003', 2, 9.99, 19.98);
INSERT INTO PRODUCT_SALES VALUES (43193, 11, 'VK003', 2, 19.95, 39.90);
INSERT INTO PRODUCT_SALES VALUES (43193, 11, 'VK004', 2, 24.95, 49.90);
INSERT INTO PRODUCT_SALES VALUES (43198, 1, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43198, 1, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43198, 1, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43198, 5, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43198, 5, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43198, 5, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43213, 3, 'BK001', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43227, 9, 'VB002', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43227, 9, 'VK002', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43241, 8, 'VB003', 1, 9.99, 9.99);
INSERT INTO PRODUCT_SALES VALUES (43241, 8, 'VK003', 1, 19.95, 19.95);
INSERT INTO PRODUCT_SALES VALUES (43241, 8, 'VK004', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 3, 'BK002', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 3, 'VB001', 1, 7.99, 7.99);
INSERT INTO PRODUCT_SALES VALUES (43256, 3, 'VB002', 2, 7.99, 15.98);
INSERT INTO PRODUCT_SALES VALUES (43256, 3, 'VK001', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 3, 'VK002', 2, 14.95, 29.90);
INSERT INTO PRODUCT_SALES VALUES (43256, 11, 'VB002', 2, 7.99, 15.98);
INSERT INTO PRODUCT_SALES VALUES (43256, 11, 'VK002', 2, 14.95, 29.90);
INSERT INTO PRODUCT_SALES VALUES (43256, 12, 'BK002', 1, 24.95, 24.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 12, 'VB003', 1, 9.99, 9.99);
INSERT INTO PRODUCT_SALES VALUES (43256, 12, 'VK002', 1, 14.95, 14.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 12, 'VK003', 1, 19.95, 19.95);
INSERT INTO PRODUCT_SALES VALUES (43256, 12, 'VK004', 1, 24.95, 24.95);

--Q2 a
SELECT  customer.CustomerName, customer.CustomerID FROM customer
Where customer.CustomerID = SOME (
SELECT product_sales.CustomerID from product_sales
GROUP BY product_sales.CustomerID
HAVING COUNT(DISTINCT product_sales.ProductNumber) >= 5
);

--Q2 b
SELECT TOP 1 P.TimeID ,C.CustomerID ,C.CustomerName, Sum(P.Total) as TotalBill
FROM product_sales P join Customer C
on C.CustomerID=P.CustomerID
GROUP BY C.CustomerID,C.CustomerName,P.TimeID
ORDER BY TotalBill DESC

--Q2 c
SELECT Year , SUM(Total) as Total from timeline INNER JOIN product_sales ON timeline.TimeID = product_sales.TimeID
GROUP BY ROLLUP (Year)

-- By Quarter 

SELECT CUSTOMER.City,TIMELINE.Quarter, TIMELINE.year, SUM(PRODUCT_SALES.Total) as Total FROM 
CUSTOMER INNER JOIN PRODUCT_SALES ON CUSTOMER.CustomerID = PRODUCT_SALES.CustomerID
INNER JOIN TIMELINE ON PRODUCT_SALES.TimeID = TIMELINE.TimeID
GROUP BY City, TIMELINE.Quarter,TIMELINE.year
HAVING TIMELINE.Quarter = 2 and TIMELINE.year = 2018

SELECT PRODUCT.ProductType,TIMELINE.Quarter, TIMELINE.year, SUM(PRODUCT_SALES.Total) as Total FROM 
PRODUCT INNER JOIN PRODUCT_SALES ON PRODUCT.ProductNumber = PRODUCT_SALES.ProductNumber
INNER JOIN TIMELINE ON PRODUCT_SALES.TimeID = TIMELINE.TimeID
GROUP BY PRODUCT.ProductType, TIMELINE.Quarter,TIMELINE.year
HAVING TIMELINE.Quarter = 2 and TIMELINE.year = 2018

-- Drill Down 

SELECT CUSTOMER.City,TIMELINE.Month, TIMELINE.year, SUM(PRODUCT_SALES.Total) as Total FROM 
CUSTOMER INNER JOIN PRODUCT_SALES ON CUSTOMER.CustomerID = PRODUCT_SALES.CustomerID
INNER JOIN TIMELINE ON PRODUCT_SALES.TimeID = TIMELINE.TimeID
GROUP BY City, TIMELINE.Quarter,TIMELINE.year,TIMELINE.Month
HAVING TIMELINE.Quarter = 2 and TIMELINE.year = 2018

SELECT PRODUCT.ProductType,TIMELINE.Month, TIMELINE.year, SUM(PRODUCT_SALES.Total) as Total FROM 
PRODUCT INNER JOIN PRODUCT_SALES ON PRODUCT.ProductNumber = PRODUCT_SALES.ProductNumber
INNER JOIN TIMELINE ON PRODUCT_SALES.TimeID = TIMELINE.TimeID
GROUP BY PRODUCT.ProductType, TIMELINE.Quarter,TIMELINE.year,TIMELINE.Month 
HAVING TIMELINE.Quarter = 2 and TIMELINE.year = 2018